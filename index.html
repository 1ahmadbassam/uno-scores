<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uno Score Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .chart-container {
            width: 100%;
            margin-bottom: 2rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8">
            <div class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Uno Score Analysis</h1>
                <p class="text-gray-500 mt-2">An interactive dashboard analyzing the game from multiple perspectives.</p>
            </div>

            <div id="loading-indicator">
                <div class="loader"></div>
                <p class="text-center text-gray-500">Loading score data...</p>
            </div>
            
            <div id="charts-wrapper" class="hidden">
                <!-- Chart 1: Score Progression -->
                <div class="chart-container">
                    <h2 class="text-xl font-bold text-gray-700 mb-1">1. Score Progression</h2>
                    <p class="text-sm text-gray-500 mb-4">The raw scores of Player A and Player I over time.</p>
                    <div id="chart-progression"></div>
                </div>
                
                <!-- Chart 2: Score Ratio -->
                <div class="chart-container">
                    <h2 class="text-xl font-bold text-gray-700 mb-1">2. Score Ratio (Player A / Player I)</h2>
                    <p class="text-sm text-gray-500 mb-4">Shows the proportional lead. The y-axis is capped for readability.</p>
                    <div id="chart-ratio"></div>
                </div>

                <!-- Chart 3: Percentage of Total Points -->
                <div class="chart-container">
                    <h2 class="text-xl font-bold text-gray-700 mb-1">3. Percentage of Total Points (Player A)</h2>
                    <p class="text-sm text-gray-500 mb-4">A stable metric showing Player A's share of the total points, indicating overall game control.</p>
                    <div id="chart-percentage"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. Fetch and Parse Data ---
        async function loadData() {
            try {
                const response = await fetch('scores.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rawData = await response.text();
                
                const data = [];
                let currentDateStr = "";
                const year = "2025";
                const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

                rawData.trim().split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;

                    const monthMatch = months.find(m => trimmedLine.startsWith(m));
                    if (monthMatch) {
                        currentDateStr = trimmedLine;
                    } else {
                        try {
                            const parts = trimmedLine.split(/\s+/);
                            const [scoreA, scoreI] = parts[0].split('-').map(Number);
                            const date = d3.timeParse("%B %d %Y %H:%M")(`${currentDateStr} ${year} ${parts[1]}`);
                            
                            if (date && !isNaN(scoreA) && !isNaN(scoreI)) {
                                const ratio = scoreI === 0 ? null : scoreA / scoreI;
                                const totalPoints = scoreA + scoreI;
                                const percentage = totalPoints === 0 ? 0 : (scoreA / totalPoints) * 100;
                                data.push({ date, scoreA, scoreI, ratio, percentage });
                            }
                        } catch (e) {
                            console.warn("Skipping malformed line:", line);
                        }
                    }
                });
                
                // Hide loader and show charts
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('charts-wrapper').classList.remove('hidden');

                return data;

            } catch (error) {
                document.getElementById('loading-indicator').innerHTML = `<p class="text-center text-red-500 font-semibold">Error: Could not load scores.txt. Make sure the file is in the same directory as this HTML file.</p>`;
                console.error("Failed to fetch or parse scores.txt:", error);
                return null;
            }
        }

        // --- 2. Chart Drawing Logic ---
        const margin = { top: 20, right: 50, bottom: 50, left: 60 };
        const tooltip = d3.select("body").append("div").attr("class", "tooltip");
        const bisectDate = d3.bisector(d => d.date).left;

        function createChart(containerId, data, yValue, yLabel, yDomain, yFormat, color) {
            const container = document.getElementById(containerId);
            let chartData = data;
            if (containerId === 'chart-ratio') {
                chartData = data.filter(d => d.ratio !== null);
            }

            function draw() {
                d3.select(container).selectAll("*").remove();
                
                const width = container.clientWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select(container).append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleTime().domain(d3.extent(data, d => d.date)).range([0, width]);
                const y = d3.scaleLinear().domain(yDomain(chartData)).range([height, 0]);

                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b")));
                svg.append("g").call(d3.axisLeft(y).tickFormat(yFormat));

                const line = d3.line().x(d => x(d.date)).y(d => y(yValue(d)));
                
                svg.append("path").datum(chartData).attr("fill", "none").attr("stroke", color).attr("stroke-width", 2.5).attr("d", line);
                
                const focus = svg.append("g").style("display", "none");
                focus.append("circle").attr("r", 5).style("fill", color).style("stroke", "white");
                
                svg.append("rect")
                    .attr("width", width).attr("height", height)
                    .style("fill", "none").style("pointer-events", "all")
                    .on("mouseover", () => { focus.style("display", null); tooltip.style("opacity", 1); })
                    .on("mouseout", () => { focus.style("display", "none"); tooltip.style("opacity", 0); })
                    .on("mousemove", event => {
                        const x0 = x.invert(d3.pointer(event)[0]);
                        const i = bisectDate(data, x0, 1);
                        const d = (data[i] && (x0 - data[i-1].date > data[i].date - x0)) ? data[i] : data[i-1];
                        
                        if (yValue(d) !== null) focus.attr("transform", `translate(${x(d.date)},${y(yValue(d))})`);

                        tooltip.html(`<strong>${d3.timeFormat("%B %d, %H:%M")(d.date)}</strong><br/>A: ${d.scoreA} | I: ${d.scoreI}<br/>Ratio: ${d.ratio ? d.ratio.toFixed(2) : 'N/A'}<br/>A's Pct: ${d.percentage.toFixed(1)}%`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                    });
            }
            draw();
            window.addEventListener('resize', draw);
        }

        function drawProgressionChart(data) {
            const containerId = 'chart-progression';
            const container = document.getElementById(containerId);
            
            function draw() {
                d3.select(container).selectAll("*").remove();
                const width = container.clientWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select(container).append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const x = d3.scaleTime().domain(d3.extent(data, d => d.date)).range([0, width]);
                const y = d3.scaleLinear().domain([0, d3.max(data, d => Math.max(d.scoreA, d.scoreI)) * 1.05]).range([height, 0]);

                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b")));
                svg.append("g").call(d3.axisLeft(y));

                svg.append("path").datum(data).attr("fill", "none").attr("stroke", "royalblue").attr("stroke-width", 2.5).attr("d", d3.line().x(d => x(d.date)).y(d => y(d.scoreA)));
                svg.append("path").datum(data).attr("fill", "none").attr("stroke", "crimson").attr("stroke-width", 2.5).attr("d", d3.line().x(d => x(d.date)).y(d => y(d.scoreI)));
                
                const legend = svg.append("g").attr("transform", `translate(${width - 100}, 0)`);
                legend.append("rect").attr("x", -10).attr("y", -10).attr("width", 110).attr("height", 50).attr("fill", "white").attr("stroke", "#ddd").attr("rx", 5).style("opacity", 0.8);
                legend.append("circle").attr("cx",0).attr("cy",0).attr("r", 6).style("fill", "royalblue");
                legend.append("circle").attr("cx",0).attr("cy",20).attr("r", 6).style("fill", "crimson");
                legend.append("text").attr("x", 15).attr("y", 0).text("Player A").style("font-size", "12px").attr("alignment-baseline","middle");
                legend.append("text").attr("x", 15).attr("y", 20).text("Player I").style("font-size", "12px").attr("alignment-baseline","middle");

                const focusA = svg.append("g").style("display", "none");
                const focusI = svg.append("g").style("display", "none");
                focusA.append("circle").attr("r", 5).style("fill", "royalblue").style("stroke", "white");
                focusI.append("circle").attr("r", 5).style("fill", "crimson").style("stroke", "white");
                svg.append("rect")
                    .attr("width", width).attr("height", height).style("fill", "none").style("pointer-events", "all")
                    .on("mouseover", () => { focusA.style("display", null); focusI.style("display", null); tooltip.style("opacity", 1); })
                    .on("mouseout", () => { focusA.style("display", "none"); focusI.style("display", "none"); tooltip.style("opacity", 0); })
                    .on("mousemove", event => {
                        const x0 = x.invert(d3.pointer(event)[0]);
                        const i = bisectDate(data, x0, 1);
                        const d = (data[i] && (x0 - data[i-1].date > data[i].date - x0)) ? data[i] : data[i-1];
                        focusA.attr("transform", `translate(${x(d.date)},${y(d.scoreA)})`);
                        focusI.attr("transform", `translate(${x(d.date)},${y(d.scoreI)})`);
                        tooltip.html(`<strong>${d3.timeFormat("%B %d, %H:%M")(d.date)}</strong><br/><span style="color: royalblue;">Player A: ${d.scoreA}</span><br/><span style="color: crimson;">Player I: ${d.scoreI}</span>`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                    });
            }
            draw();
            window.addEventListener('resize', draw);
        }

        // --- 3. Main Execution ---
        document.addEventListener('DOMContentLoaded', async () => {
            const data = await loadData();
            if (data) {
                drawProgressionChart(data);
                createChart('chart-ratio', data, d => d.ratio, 'Ratio (A/I)', chartData => [0, Math.min(10, d3.max(chartData, d => d.ratio))], d3.format(".1f"), '#22c55e');
                createChart('chart-percentage', data, d => d.percentage, "Player A's Point Share", () => [0, 100], d => `${d}%`, '#f97316');
            }
        });
    </script>
</body>
</html>